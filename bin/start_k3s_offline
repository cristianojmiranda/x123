#!/bin/bash
source env.sh

mkdir -p $_K3S_IMAGES

#docker pull traefik:1.7.9
#docker pull coredns/coredns:1.3.0
#docker pull rancher/klipper-lb:v0.1.1
#docker pull rancher/klipper-helm:v0.1.3
#docker pull quay.io/kubernetes_incubator/nfs-provisioner

docker save traefik -o $_K3S_IMAGES/traefik.tar
docker save coredns/coredns -o $_K3S_IMAGES/coredns.tar
docker save rancher/klipper-lb -o $_K3S_IMAGES/klipper-lb.tar
docker save rancher/klipper-helm -o $_K3S_IMAGES/klipper-helm.tar

docker save vault -o $_K3S_IMAGES/vault.tar
docker save consul -o $_K3S_IMAGES/consul.tar
docker save rabbitmq -o $_K3S_IMAGES/rabbitmq.tar
docker save quay.io/kubernetes_incubator/nfs-provisioner -o $_K3S_IMAGES/nfs-provisioner.tar

ls -lh $_K3S_IMAGES

start_k3s
#kkn kube-system edit jobs helm-install-traefik
kkn kube-system get jobs helm-install-traefik -o yaml | sed -e 's/imagePullPolicy:.*/imagePullPolicy: IfNotPresent/g' | kubectl -n kube-system apply --force=true --filename -
