#!/bin/bash
source env.sh

echo "Starting k3s cluster...."
docker-compose --file=$_RESOURCES/k3s-docker-compose.yaml up -d

echo "Waiting cluster to be ready..."
while true; do
	if [[ -f $_WORKDIR/kubeconfig.yaml ]]; then
		break
	else
		echo '.'
		sleep 5
	fi
done

mkdir -p ~/.kube
cat $_WORKDIR/kubeconfig.yaml  > ~/.kube/config
kube_info

# fix dns
kubectl apply -f $_RESOURCES/coredns.yaml
docker-compose --file=$_RESOURCES/k3s-docker-compose.yaml logs --follow
