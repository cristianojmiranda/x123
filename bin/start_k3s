#!/bin/bash
source env.sh

echo "Starting k3s cluster...."
mkdir /tmp/data
mkdir /tmp/images

if [[ -e $_WORKDIR/k3s_nodes ]]; then
	docker-compose --file=$_RESOURCES/k3s-docker-compose.yaml up -d --scale node=$(cat $_WORKDIR/k3s_nodes)
else
	docker-compose --file=$_RESOURCES/k3s-docker-compose.yaml up -d
fi

echo "Waiting cluster to be ready..."
while true; do
	if [[ -f $_WORKDIR/kubeconfig.yaml ]]; then
		break
	else
		echo '.'
		sleep 5
	fi
done

mkdir -p ~/.kube
cat $_WORKDIR/kubeconfig.yaml  > ~/.kube/config
kube_info

# fix dns
kubectl apply -f $_RESOURCES/coredns.yaml
docker-compose --file=$_RESOURCES/k3s-docker-compose.yaml logs --follow
